# Описание отчетов и функций CRM

В этом документе кратко описаны примеры SQL-скриптов и функций для работы с crm системой.  

*Примечание:* Все рпабочие скрипты лежат в '/queries_and_functions'

## 1. История коммуникаций по сделке (`get_chat_history.sql`)

Функция `get_chat_history(search_id int)`:

- По ID сделки возвращает полную историю коммуникаций по этой сделке.
- Что делает:
    - Собирает в один хронологический список:
        - сообщения из чата;
        - звонки;
        - письма.
    - Для каждого события показывает:
        - ID события;
        - тип события (сообщение / звонок / письмо);
        - ID сотрудника;
        - текст сообщения/письма (если есть);
        - время события.
- Оптимизация:
    - Созданы B-Tree индексы по `(deal_id, send_at/call_at)` в таблицах `chat_message`, `call_logs`, `email_message` для ускорения выборки и сортировки по времени.
---

## 2. Отчёт по эффективности менеджеров за месяц (`managers_efficiency.sql`)

Запрос формирует агрегированный отчёт по менеджерам за последние 30 дней.

- Для каждого менеджера считает:
    - количество созданных сделок за 30 дней;
    - количество закрытых сделок за 30 дней;
    - сумму закрытых сделок за 30 дней;
    - средний рейтинг по отзывам клиентов;
    - среднее время жизни сделки (от создания до закрытия).
---

## 3. Топ‑5 самых дорогих товаров по компаниям (`top_five_expensive.sql`)

- Запрос выбирает пять самых дорогих товаров в разрезе каждой компании.

---

## 4. Список просроченных задач (`overdued_tasks.sql`)

Запрос выводит все просроченные задачи по компании.

- Что показывает:
    - ID задачи;
    - ID сотрудника;
    - ФИО ответственного;
    - дедлайн задачи;
    - насколько задача просрочена (разница между `task_deadline` и текущим временем).

---

## 5. Топ‑5 самых продаваемых продуктов по компаниям (`top_five_sold_products.sql`)

- Запрос строит топ‑5 самых продаваемых (по количеству) продуктов в разрезе компаний за текущий год.

---
