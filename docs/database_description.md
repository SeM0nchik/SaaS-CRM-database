## Краткое описание

Вы проектируете базу данных для облачной SaaS CRM системы для компаний. Каждая компания ведет свою клиентскую и торговую работу в одном сервисе.

- На платформе есть *Компании* ( каждая компания независима и не видит чужих данных а работает только внутри своей системы). Внутри каждой компании есть *пользователи* (администраторы, менеджеры и работники). У каждого из этих сотрудников есть ФИО, рабочий уникальный корпоративный email. Система также хранит информацию о дате регистрации пользователя и содержит информацию о его компании.
- *Компания* может иметь много *Клиентов* (контактные лица или организации). У каждой компании есть свой список клиентов. Каждый клиент имеет ФИО, должность ( опционально ), обязательно номер телефона и  email.
- За *менеджером* может быть закреплено одна или несколько различных *сделок* с *клиентами*. На одну *сделку* может быть один *клиент-инициатор*. Все общение и работа происходит именно с этим клиентом ( на стороне компании главное ответственное лицо - менеджер, на стороне клиента - сам клиент ). У каждой сделки есть название, описание, сумма и статус - new, active и closed.
- У каждой *Сделки* есть один или несколько уникальных *Тэгов*.
- В каждую *Сделку* может входить несколько различных типов *Товаров* ( услуг ) которые производит конкретная компания. У товара есть имя, описание и цена. В сделку может входить несколько экземпляров одного и того же товара. При этом фиксируется цена, по которой товар проходил в сделке. То есть при изменении цены товара, стоимость и цена товаров в активных сделках измениться не должна.
- По каждой *сделке* *менеджер* выдает *сотрудникам* несколько *задач*. Каждая *задача* закрепляется за определенным *сотрудником* и должна быть выполнена к определенному сроку ( дедлайну ). У задачи есть описание, название, статус и результат.
- К задаче любой из сотрудников может оставить текстовый *Комментарий*, другие сотрудники/менеджеры могут ответить на комментарий.
- Все важные действия (создание/изменение/закрытие сделки/выполнение задачи/смена клиента/смена ответственного) фиксируется в *Журнале действий* ( логах ) - по ним можно в любой момент просмотреть историю работы по клиенту или по сделке
- Когда сделка переводиться в статус 'закрыта' компания может сохранить *Отзыв клиента*: рейтинг по 5-балльной шкале и текстовый комментарий, время создания.
- Все общение с *клиентом* хранится в CRM системе - все *письма*, *сообщения* и *звонки*. Менеджер вправе делегировать общение с клиентом на определенных сотрудников. По сделке хранится общая история чатов и уведомлений,  менеджер видит какой сотрудник отвечал на сообщения клиента.
- Каждый *звонок* закреплен за определенным сотрудником и сделкой. У него есть направления - исходящий/входящий. Хранится номер звонка, его длительность и время когда был совершен звонок.
- Каждая *сообщение* *по* *почте* также ассоциируется с определенным сотрудником и сделкой, имеет свой тип - исходящий/входящий. В системе хранится заголовок ( subject ) письма, его тело ( body ) и время отправки
- Каждое *сообщение* также привязано к сделке и к сотруднику, у него есть свой канал ( телеграмм, whatsapp и тд), есть направление ( входящее/ исходящее) и сам текст сообщение и время отправки.
- В базе реализована система ролей: у каждого пользователя есть роли (менеджер, администратор, сотрудник)
    - Администратор: **Полный доступ** ко всем данным компании, к настройкам, редактированию и управлению всеми элементами CRM.
        - Добавлять/удалять сотрудников.
        - Назначать роли (менеджер/сотрудник) другим пользователям.
        - Сброс паролей и разблокировка пользователей.
        - Просматривать, создавать, редактировать и удалять любые сделки, контакты, задачи.
        - Просматривать историю всех действий и изменений по всей компании.
        - Определять/менять права для всех ролей, групп сотрудников/отделов.
        - Не видит данные других компаний.
    - Менеджер:
        - Просматривать, создавать и редактировать свои сделки, задачи, клиентов.
        - Может видеть сделки/контакты, где он назначен ответственным (или где состоит в качестве участника задачи).
        - Менять статусы сделок, закрывать/открывать сделки, назначать задачи себе и коллегам из отдела (если разрешено).
        - Добавлять новых клиентов, редактировать их данные.
        - Просматривать отчеты по своим продажам/задачам.
        - Видеть свой рейтинг, историю своих задач и сделок.
        - Не может изменить роли сотрудников и доступ других пользователей.
        - Не может удалить других пользователей или менять права.
        - Доступ обычно строго ограничен “своими” данными и задачами, данными своей компании.
        - Видит, редактирует и закрывает только те сделки/задачи, за которые отвечает, или которые заведены на него/его отдел.
    - Сотрудник:
        - Видит свои задачи, сделки, клиентов (только те, где назначен исполнителем или участником).​
        - Может добавлять комментарии, отмечать выполнение задач.
        - Может создавать задачи/заметки по уже существующим клиентам/сделкам (если разрешено политикой).
        - Завершение/отметка о выполнении заданий.
        - Видит историю только своих действий.
        - Никакого доступа к управлению пользователями, настройкам, удалению данных.
        - Не может просматривать сделки/задачи, не относящиеся к нему.
        - Не может создавать новых клиентов/сделок.
        - Не может изменять права, настройки системы.

## Создание ER-модели на основе требований

### Сущности и их аттрибуты

- Компания ( company ) : company_id, company_name, company_desc, registration_date
- Пользователь ( employees ) :  employee_id (PK), company_id,, employee_name, employee_email, registration_date, role
- Клиент ( clients ) : client_id, company_id, client_name, client_email, client_phone, client_post
- Сделка ( deal ): deal_id, client_id, manager_id,  deal_name, deal_desc, amount, deal_status, creation_date, close_date
- Товар ( product ): product_id, product_name, product_desc, product_price
- Задача ( task ) : task_id, deal_id, employee_id, task_desc, task_deadline, task_status, task_result
- Комментарий (comment) : (comment_id, parent_comment_id , task_id, employee_id, comment_text, created_at)
- Журнал действий ( activity_logs ):  log_id, company_id, user_id, action_type, object_type, object_id, status, message
- Отзыв клиента ( client_review ) :  deal_id, creation_date, rating, text
- Тэги (tags) : tag_id, tag_name, tag_desc
- Сообщения по почте ( email_message ) : email_id, employee_id, client_id, deal_id, direction, subject, body, sent_at
- Логи звонков ( call_logs ): call_id, employee_id, client_id, deal_id, direction, phone, duration, call_at
- Сообщения в чатах (chat_messages) : message_id, employee_id, client_id, deal_id, channel, direction, body, sent_at

### Связи и их кардинальность
- Сотрудники ( менеджеры, администраторы, рабочие) работают в одной определенной компании. *N : 1*
- У компании есть множество ее клиентов. *1 : N*
- Компания заключает сделки с клиентом. *M : N* - сущность сделка где будут храниться вся информация о сделке и FK на компанию и клиента
- Сделка содержит в себе множество товаров. *M:N* -> выносим эту связь в отдельную табличку product_by_deal, где храним информацию какой продукт в каком количестве и по какой цене входит в сделку
- По каждой сделке менеджер назначает сотрудникам множества задач. Сделка (1) : Задачи (N), Сотрудник (1) : Задачи (N)
- Пользователь может оставить комментарий на задачу. *1 : N*
- Комментарий может быть ответом на другой комментарий. *1 : 1*
- Клиент может оставить отзыв на сделку. *1 : N*
- Клиенту могу позвонить, написать по почте/в чате разные сотрудники по сделке. *1:N*, *1:N*, *1:N*
- Каждая сделка имеет несколько почтовых сообщений. *1 : N*
- Каждая сделка имеет несколько сообщений в чатах.  *1 : N*
- Каждая сделка имеет историю звонков. *1 : N*
- Каждая сделка имеет несколько тэгов. *M : N* -> требуется отдельная таблица deal_by_tags хранящая информацию о сделке и ее тэге.
