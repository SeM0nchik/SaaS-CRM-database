# Нормализация таблиц CRM

Этот раздел содержит анализ нормализации всех таблиц схемы CRM. Для каждой таблицы указываются:  
– **Описание** (что это за сущность),  
– **Атрибуты** (столбцы),  
– **Функциональные зависимости** (какой ключ однозначно определяет остальные данные).

---

## Company

**Описание:**  
Компании — организации, участвующие в системе (арендатор CRM).

**Атрибуты:**
- company_id (PK)
- company_name
- company_desc
- registration_date

**Функциональные зависимости:**
- company_id → company_name, company_desc, registration_date

**Нормализация:**  
Сущность в 3НФ: все неключевые атрибуты функционально зависят только от PK.

---

## Employee

**Описание:**  
Сотрудники, работающие в компаниях, с ролевым разграничением.

**Атрибуты:**
- employee_id (PK)
- company_id (FK)
- employee_name NN
- employee_email UNIQUE (корпоративный email у всех разный)
- registration_date
- role

**Функциональные зависимости:**
- employee_id → company_id, employee_name, employee_email, registration_date, role

**Нормализация:**  
В 3НФ: каждый атрибут зависит только от PK employee_id.

---

## Client

**Описание:**  
Контактные лица или организации-клиенты компании.

**Атрибуты:**
- client_id (PK)
- company_id (FK)
- client_name NN
- client_email NN
- client_phone NN
- client_post

**Функциональные зависимости:**
- client_id → company_id, client_name, client_email, client_phone, client_post

**Нормализация:**  
В 3НФ: все атрибуты зависят исключительно от client_id.

---

## Deal

**Описание:**  
Сделки между компанией и клиентом.

**Атрибуты:**
- deal_id (PK)
- client_id (FK)
- manager_id (FK)
- deal_name NN
- deal_desc
- amount
- deal_status NN
- creation_date
- close_date

**Функциональные зависимости:**
- deal_id → client_id, manager_id, deal_name, deal_desc, amount, deal_status, creation_date, close_date

**Нормализация:**  
В 3НФ: отсутствуют транзитивные зависимости

---

## Product

**Описание:**  
Продукты/услуги, предлагаемые компаниями.

**Атрибуты:**
- product_id (PK)
- company_id (FK)
- product_name NN
- product_desc
- product_price CHECK > 0

**Функциональные зависимости:**
- product_id → company_id, product_name, product_desc, product_price

**Нормализация:**  
В 3НФ.

---

## Task

**Описание:**  
Задачи, возникающие при работе по сделке.

**Атрибуты:**
- task_id (PK)
- deal_id (FK)
- employee_id (FK)
- task_desc
- task_deadline NN
- task_status NN
- task_result

**Функциональные зависимости:**
- task_id →  deal_id, employee_id, task_desc, task_deadline, task_status, task_result

**Нормализация:**  
В 3НФ, нет транзитивных функциональных зависимостей.

---

## Chat_message

**Описание:**  
Сообщения в чатах между сотрудниками, клиентами и системой.

**Атрибуты:**
- message_id (PK)
- deal_id (FK)
- employee_id (FK)
- direction NN
- channel
- body
- sent_at

**Функциональные зависимости:**
- message_id → deal_id, employee_id,  channel, sender_type, sender_id, body, sent_at


**Нормализация:**  
В 3НФ,  отсутствуют транзитивные зависимости

---

## Email_message

**Описание:**  
Письма, отправленные или полученные в рамках деятельности (по клиентам, сделкам).

**Атрибуты:**
- email_id (PK)
- deal_id (FK)
- employee_id (FK)
- direction
- subject
- body
- sent_at

**Функциональные зависимости:**
- email_id → deal_id, direction, subject, body, sent_at

**Нормализация:**  
В 3НФ,  отсутствуют транзитивные зависимости

---

## Call_logs

**Описание:**  
Информация о телефонных звонках по клиентам и сделкам.

**Атрибуты:**
- call_id (PK)
- deal_id (FK)
- employee_id (FK)
- direction NN
- phone NN
- duration NN
- call_at

**Функциональные зависимости:**
- call_id → company_id,employee_id, client_id, deal_id, direction, phone, duration, call_at

**Нормализация:**  
В 3НФ,  отсуттствуют транзитивные зависимости

---

## Comment

**Описание:**  
Комментарии к сделкам, задачам и другим объектам.

**Атрибуты:**
- comment_id (PK)
- parent_comment_id (FK)
- employee_id (FK)
- task_id(FK)
- comment_text
- created_at

**Функциональные зависимости:**
- comment_id → task_id, parent_comment_id, employee_id, comment_text, created_at

**Нормализация:**  
В 3НФ,  отсутствуют транзитивные зависимости

---

## Activity_logs

**Описание:**  
Подробная история изменений и событий в системе.

**Атрибуты:**
- log_id (PK)
- user_id (FK)
- action_type
- object_type
- object_id
- status
- message

**Функциональные зависимости:**
- log_id → user_id, action_type, object_type, object_id, status, message

**Нормализация:**  
В 3НФ, отсутствуют транзитивные зависимости

---

## Client_review

**Описание:**  
Отзывы клиентов по завершённым сделкам.

**Атрибуты:**
- review_id (PK)
- deal_id (FK)
- rating ( от 0 до 5)
- message

**Функциональные зависимости:**
- review_id →  deal_id, rating, message


**Нормализация:**  
В 3НФ, транзитивная функциональная зависимость отстутствует

---

## Tags

**Описание:**  
Справочник тегов для сделок (и, по необходимости, других сущностей).

**Атрибуты:**
- tag_id (PK)
- tag_name (unique)
- tag_desc

**Функциональные зависимости:**
- tag_id → tag_name, tag_desc

**Нормализация:**  
В 3НФ.

---

## Deal_by_tag

**Описание:**  
Связка "многие-ко-многим" между сделками и тегами.

**Атрибуты:**
- deal_id (FK)
- tag_id (FK)

**Функциональные зависимости:**
- (deal_id, tag_id) → определяет уникальную связь между сделкой и тэгом

**Нормализация:**  
В 3НФ.

---

## Product_by_deal

**Описание:**  
Связка "многие-ко-многим" между сделками и продуктами, с указанием количества и цены.

**Атрибуты:**
- deal_id (FK)
- product_id (FK)
- count NN
- price NN

**Функциональные зависимости:**  
- (deal_id, product_id) → count, price

**Нормализация:**  
В 3НФ.

---

# Вывод

Все таблицы находятся в 3ей НФ Бойса Кодда так как во всех таблицах первичный ключ является суперключом, в каждой таблице все атрибуты атомарны, зависят от полного первичного ключа и не зависят ни от чего больше чем от ключа. При этом можно рассуждать о том, что все таблицы также находятся и в 4ой НФ так как ни у одной из представленных таблиц нет нетривиальных многозначных зависимостей.

Однако, данная нормализовнная схема не всегда является самым оптимальным решением для создания базы данных, особенно в CRM SaaS системе, где базы данных ( сервера, которые покупает CRM и продает арендаторам ) должны уметь быстро находить данные для каждой компании, а это может быть реализовано с помощью шардирования базы данных.

Нашу базу данных логичнее всего шардировать по company_id - то есть разделить данные по компаниям, но для такого деления необходимо выполнить сложные многоступенчатые  джоины ( чтобы для каждого кортежа иметь company_id), а это как известно занимает достаточно много времени. Поэтому спроектированная мною база данных в соответствии с ТЗ является не самым оптимальным решением для поставленной задачи.

Лучшее решение - отказаться от нормализации по 3НФ и Бойсу-Кодду и сохранить 2НФ, но при этом иметь в каждом кортеже под рукой company_id, чтобы каждую БД было удобно разбить по маленьким кусокчкам и хранить их на отдельных серверах.
